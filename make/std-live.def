# -*- Makefile -*-
#
# michael aivazis
# orthologue
# (c) 1998-2015 all rights reserved
#

# support for publishing projects to a live host

# libraries and their headers
live-headers:
	$(SSH) $(PROJ_LIVE_USERURL) '$(MKDIRP) $(PROJ_LIVE_INCDIR)/$(PROJECT)'
	$(SCP) $(EXPORTED_HEADERS) $(PROJ_LIVE_USERURL):$(PROJ_LIVE_INCDIR)/$(PROJECT)

live-package-headers:
	$(SSH) $(PROJ_LIVE_USERURL) '$(RM_RF) $(PROJ_LIVE_INCDIR)/$(PROJECT)/$(PACKAGE)'
	$(SSH) $(PROJ_LIVE_USERURL) '$(MKDIRP) $(PROJ_LIVE_INCDIR)/$(PROJECT)/$(PACKAGE)'
	$(SCP) $(EXPORTED_PKG_HEADERS) $(PROJ_LIVE_USERURL):$(PROJ_LIVE_INCDIR)/$(PROJECT)/$(PACKAGE)

live-libraries:
	$(SSH) $(PROJ_LIVE_USERURL) '$(MKDIRP) $(PROJ_LIVE_LIBDIR)'
	$(SCP) $(EXPORT_LIBS) $(PROJ_LIVE_USERURL):$(PROJ_LIVE_LIBDIR)

# python packages
live-python-modules:
	$(SSH) $(PROJ_LIVE_USERURL) '$(RM_RF) $(PROJ_LIVE_PKGDIR)/$(PROJECT)'
	$(SSH) $(PROJ_LIVE_USERURL) '$(MKDIRP) $(PROJ_LIVE_PKGDIR)/$(PROJECT)'
	$(SCP) $(EXPORT_MODULEDIR)/*.py[cod] $(PROJ_LIVE_USERURL):$(PROJ_LIVE_PKGDIR)/$(PROJECT)

live-package-python-modules:
	$(SSH) $(PROJ_LIVE_USERURL) '$(RM_RF) $(PROJ_LIVE_PKGDIR)/$(PROJECT)/$(PACKAGE)'
	$(SSH) $(PROJ_LIVE_USERURL) '$(MKDIRP) $(PROJ_LIVE_PKGDIR)/$(PROJECT)/$(PACKAGE)'
	$(SCP) $(EXPORT_MODULEDIR)/$(PACKAGE)/*.py[cod] $(PROJ_LIVE_USERURL):$(PROJ_LIVE_PKGDIR)/$(PROJECT)/$(PACKAGE)

# installation of binaries
live-bin:
	$(SSH) $(PROJ_LIVE_USERURL) '$(MKDIRP) $(PROJ_LIVE_BINDIR)'
	$(SCP) $(EXPORT_BINS) $(PROJ_LIVE_USERURL):$(PROJ_LIVE_BINDIR)

# installation of extra files and application runtime directories
live-etc live-var:
	$(SSH) $(PROJ_LIVE_USERURL) '$(RM_RF) $(PROJ_LIVE_ETCDIR)'
	$(SSH) $(PROJ_LIVE_USERURL) '$(MKDIRP) $(PROJ_LIVE_ETCDIR)'
	$(SCP_R) $(EXPORT_ETC) $(PROJ_LIVE_USERURL):$(PROJ_LIVE_ETCDIR)

# web site management

# N.B.: live-web removes the target direcories on the remote machine by loggin in as root; the
# reason for that is that apache builds a cache as {www-data} and uses its user's umask, making
# the target folder impossible to delete as the remote project user
live-web:
	$(SSH) $(PROJ_LIVE_ADMINURL) '$(RM_RF) $(PROJ_LIVE_WEBDIR)/$(PROJECT)'
	$(SSH) $(PROJ_LIVE_USERURL) '$(MKDIRP) $(PROJ_LIVE_WEBDIR)/$(PROJECT)'
	$(SCP_R) $(EXPORT_WEB) $(PROJ_LIVE_USERURL):$(PROJ_LIVE_WEBDIR)/$(PROJECT)

live-web-package:
	$(SSH) $(PROJ_LIVE_ADMINURL) '$(RM_RF) $(PROJ_LIVE_WEBDIR)/$(PROJECT)/$(PACKAGE)'
	$(SSH) $(PROJ_LIVE_USERURL) '$(MKDIRP) $(PROJ_LIVE_WEBDIR)/$(PROJECT)/$(PACKAGE)'
	$(SCP_R) $(EXPORT_WEB) $(PROJ_LIVE_USERURL):$(PROJ_LIVE_WEBDIR)/$(PROJECT)/$(PACKAGE)

# place the apache configuration files in the right spot
LIVE_APACHE_CONF = /etc/apache2/sites-available/$(PROJECT).conf
LIVE_SITE_CONF = $(PROJ_LIVE_WEBDIR)/apache/$(PROJ_LIVE_APACHE_CONF)

live-apache-conf:
	$(SSH) $(PROJ_LIVE_USERURL) '$(MKDIRP) $(PROJ_LIVE_WEBDIR)/apache'
	$(SCP) $(PROJ_LIVE_APACHE_ALL) $(PROJ_LIVE_USERURL):$(PROJ_LIVE_WEBDIR)/apache

live-apache-site-enable:
	$(SSH) $(PROJ_LIVE_ADMINURL) '$(RM_F) $(LIVE_APACHE_CONF)'
	$(SSH) $(PROJ_LIVE_ADMINURL) '$(LN_S) $(LIVE_SITE_CONF) $(LIVE_APACHE_CONF)'
	$(SSH) $(PROJ_LIVE_ADMINURL) 'a2ensite $(PROJECT)'

live-apache-restart:
	$(SSH) $(PROJ_LIVE_ADMINURL) 'service apache2 restart'

live-apache: live-apache-conf live-apache-site-enable live-apache-restart

# create the overall directory layout on the remore host
live-dirs:
	$(SSH) $(PROJ_LIVE_USERURL) '$(MKDIRP) $(PROJ_LIVE_DIRS)'

live-vardir:
	$(SSH) $(PROJ_LIVE_USERURL) '$(MKDIRP) $(PROJ_LIVE_VARDIR)'

# end of file
