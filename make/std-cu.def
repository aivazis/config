# -*- Makefile -*-
#
# michael a.g. aivazis
# parasim
# (c) 1998-2018 all rights reserved
#

# Default settings for NVCC compilation

# Developer preferences
    DEV_NVCC_FLAGS ?=
    DEV_NVCC_INCLUDES ?=
    DEV_NVCC_DEFINES ?=
    DEV_LNVCC_FLAGS ?=
    DEV_LNVCC_LIBPATH ?=


# Construction of compiler command line
    NVCC_FLAGS = $(PLATFORM_NVCC_FLAGS) $(COMPILER_NVCC_FLAGS) $(TARGET_NVCC_FLAGS) \
	     $(DEV_NVCC_FLAGS) $(PROJ_NVCC_FLAGS)
    NVCC_INCLUDES = $(PLATFORM_NVCC_INCLUDES) \
		$(COMPILER_NVCC_INCLUDES) $(TARGET_NVCC_INCLUDES) \
		$(DEV_NVCC_INCLUDES) $(PROJ_NVCC_INCLUDES) $(EXTERNAL_INCLUDES) 
    NVCC_DEFINES = $(PLATFORM_NVCC_DEFINES) $(COMPILER_NVCC_DEFINES) \
	       $(TARGET_NVCC_DEFINES) $(DEV_NVCC_DEFINES) $(PROJ_NVCC_DEFINES) \
	       $(EXTERNAL_DEFINES)
    LNVCC_FLAGS = $(PLATFORM_LNVCC_FLAGS) $(COMPILER_LNVCC_FLAGS) \
	      $(TARGET_LNVCC_FLAGS) $(DEV_LNVCC_FLAGS) $(PROJ_LNVCC_FLAGS)
    LNVCC_LIBPATH = $(PLATFORM_LNVCC_LIBPATH) $(TARGET_LNVCC_LIBPATH) \
		$(DEV_LNVCC_LIBPATH) $(PROJ_LNVCC_LIBPATH) $(EXTERNAL_LIBPATH)

    NVCC_SOFLAGS = $(COMPILER_NVCC_SOFLAGS)
    LNVCC_SOFLAGS = $(COMPILER_LNVCC_SOFLAGS) $(EXTERNAL_SOFLAGS)

    NVCFLAGS = $(NVCC_BUILD_DEFINES) $(NVCC_BUILD_INCLUDES) $(NVCC_FLAGS)
    LNVCFLAGS = $(LNVCC_FLAGS) ${addprefix -L, $(LNVCC_LIBPATH)}
    LNVCC_FORTRAN = $(COMPILER_LNVCC_FORTRAN)


# Compile cuda source
$(PROJ_TMPDIR)/%.$(EXT_OBJ): %.$(EXT_CU)
	@$(LOGEMIT_DEPENDS_START)
	@$(NVCC_MAKEDEPEND) | \
          sed -e 's?^[^/].*:?$(PROJ_TMPDIR)/&?' > $(PROJ_TMPDIR)/$*.$(EXT_DEPEND) ; \
	tr -s '[:space:]' '\n' < $*.$(EXT_DEPEND) > $*.tmp.$(EXT_DEPEND) ; \
	sed -e 's/^ *//' -e 's/#.*//' -e 's/^[^:]*: *//' \
	  -e 's/ *\\$$//' -e '/^$$/ d' -e 's/$$/ :/' < $*.tmp.$(EXT_DEPEND) \
	  >> $(PROJ_TMPDIR)/$*.$(EXT_DEPEND) ; \
	$(RM) $(RMFLAGS) $*.$(EXT_DEPEND) $*.tmp.$(EXT_DEPEND)
	@$(LOGEMIT_DEPENDS_END)
	@$(LOGEMIT_COMPILING_START)
	$(NVCC_COMPILE_COMMAND)
	@-$(TAGS) $(TAGS_FLAGS) -o $(TAGS_FILE) $*.$(EXT_C) $*.$(EXT_CH)
	@$(LOGEMIT_COMPILING_END)

# Compile command
NVCC_COMPILE_COMMAND = $(NVCC) $(NVCFLAGS) -c -o $@ $<

# Generate dependencies for cuda source

ifdef NVCC_MAKEDEPENDS_FILE
NVCC_MAKEDEPEND = $(COMPILER_NVCC_DEPENDS) $(NVCC_BUILD_DEFINES) \
		$(NVCC_BUILD_INCLUDES) $<
else
NVCC_MAKEDEPEND = $(COMPILER_NVCC_DEPENDS) $(NVCC_BUILD_DEFINES) \
		$(NVCC_BUILD_INCLUDES) $< > $*.$(EXT_DEPEND)
endif

# Generate precompiled headers if supported

ifdef USE_NVCCPRECOMP_HEADERS
$(NVCCPPRECOMP_HEADERS)
endif

# end of file
